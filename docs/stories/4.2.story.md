# Story 4.2: 노트 내용 기반 자동 요약 생성

## Status

Completed

## Story

**As a** 사용자,
**I want** 작성한 노트의 내용을 AI가 자동으로 요약해주는 기능,
**so that** 긴 노트의 핵심 내용을 빠르게 파악하고 효율적으로 관리할 수 있다.

## Acceptance Criteria

1. 노트 작성/수정 시 자동 요약 생성 옵션이 제공되어야 한다
2. 요약은 3-6개의 불릿 포인트 형태로 생성되어야 한다
3. 요약 생성 중 로딩 상태가 명확히 표시되어야 한다
4. 생성된 요약을 사용자가 수동으로 편집할 수 있어야 한다
5. 요약 재생성 기능이 제공되어야 한다
6. 노트 내용이 너무 짧은 경우 요약 생성을 제한해야 한다 (최소 100자)
7. AI 요약 생성 실패 시 적절한 에러 메시지를 표시해야 한다
8. 요약 생성 시간이 15초를 초과하면 타임아웃 처리되어야 한다
9. 노트 목록에서 요약 내용을 미리볼 수 있어야 한다
10. 요약 데이터가 데이터베이스에 저장되어야 한다

## Tasks / Subtasks

-   [x] 데이터베이스 스키마 확장 (AC: 10)
    -   [x] notes 테이블에 summary 컬럼 추가
    -   [x] summary 생성 시간 및 상태 추적 필드 추가
    -   [x] 마이그레이션 파일 생성 및 적용
-   [x] 요약 생성 UI 컴포넌트 구현 (AC: 1, 3, 4, 5)
    -   [x] 요약 생성 버튼 및 토글 스위치
    -   [x] 요약 표시 및 편집 영역
    -   [x] 로딩 스피너 및 진행 상태 표시
    -   [x] 요약 재생성 버튼
-   [x] 요약 생성 로직 구현 (AC: 2, 6, 7, 8)
    -   [x] 노트 내용 길이 검증
    -   [x] Gemini API 호출 로직
    -   [x] 요약 포맷팅 및 후처리
    -   [x] 에러 처리 및 타임아웃 관리
-   [x] 요약 데이터 관리 (AC: 9, 10)
    -   [x] 요약 저장/조회 API 구현
    -   [x] 노트 목록에 요약 표시 기능
    -   [x] 요약 업데이트 로직
    -   [x] 요약 삭제 및 재생성 처리

## Dev Notes

### 기술 스택 정보

[Source: docs/architecture.md#1-기술-스택]

-   **프레임워크:** Next.js (App Router, Server Actions)
-   **AI API:** Google Gemini API (@google/genai)
-   **데이터베이스:** Supabase Postgres + Drizzle ORM
-   **UI:** shadcn/ui + Tailwind CSS

### 데이터베이스 스키마 확장

**notes 테이블 확장:**

```sql
-- 요약 관련 컬럼 추가
ALTER TABLE notes ADD COLUMN summary TEXT;
ALTER TABLE notes ADD COLUMN summary_generated_at TIMESTAMP;
ALTER TABLE notes ADD COLUMN summary_status VARCHAR(20) DEFAULT 'none';
-- summary_status: 'none', 'generating', 'completed', 'failed'
```

**Drizzle 스키마 업데이트:**

```typescript
// lib/db/schema/notes.ts
export const notes = pgTable('notes', {
  // ... 기존 필드들
  summary: text('summary'),
  summaryGeneratedAt: timestamp('summary_generated_at'),
  summaryStatus: varchar('summary_status', { length: 20 }).default('none'),
})
```

### 요약 생성 프롬프트 설계

**기본 요약 프롬프트:**

```typescript
const SUMMARY_PROMPT = `다음 노트 내용을 3-6개의 불릿 포인트로 요약해주세요. 
각 포인트는 핵심 내용을 간결하고 명확하게 표현해야 합니다.

규칙:
- 각 불릿 포인트는 한 문장으로 작성
- 중요도 순으로 정렬
- 불필요한 세부사항 제외
- 명사형 종결 사용

노트 내용:
{content}

요약:`
```

### 요약 생성 컴포넌트 구조

**SummaryGenerator 컴포넌트:**

```typescript
// components/notes/summary-generator.tsx
interface SummaryGeneratorProps {
  noteId: string
  content: string
  existingSummary?: string
  onSummaryGenerated: (summary: string) => void
}

export function SummaryGenerator({
  noteId,
  content,
  existingSummary,
  onSummaryGenerated
}: SummaryGeneratorProps) {
  const [isGenerating, setIsGenerating] = useState(false)
  const [summary, setSummary] = useState(existingSummary || '')
  const [error, setError] = useState<string | null>(null)

  // 요약 생성 로직
  const generateSummary = async () => {
    if (content.length < 100) {
      setError('노트 내용이 너무 짧습니다 (최소 100자)')
      return
    }

    setIsGenerating(true)
    setError(null)

    try {
      const response = await fetch('/api/notes/generate-summary', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ noteId, content })
      })

      const result = await response.json()
      
      if (result.success) {
        setSummary(result.summary)
        onSummaryGenerated(result.summary)
      } else {
        setError(result.error)
      }
    } catch (error) {
      setError('요약 생성에 실패했습니다.')
    } finally {
      setIsGenerating(false)
    }
  }

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <Label>AI 요약</Label>
        <Button 
          onClick={generateSummary}
          disabled={isGenerating || content.length < 100}
          size="sm"
        >
          {isGenerating ? (
            <>
              <Loader2 className="w-4 h-4 mr-2 animate-spin" />
              요약 생성 중...
            </>
          ) : (
            <>
              <Sparkles className="w-4 h-4 mr-2" />
              {summary ? '요약 재생성' : '요약 생성'}
            </>
          )}
        </Button>
      </div>

      {error && (
        <Alert variant="destructive">
          <AlertCircle className="h-4 w-4" />
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}

      {summary && (
        <div className="space-y-2">
          <Textarea
            value={summary}
            onChange={(e) => setSummary(e.target.value)}
            placeholder="요약 내용이 여기에 표시됩니다..."
            rows={4}
            className="resize-none"
          />
          <p className="text-xs text-muted-foreground">
            요약을 직접 편집할 수 있습니다.
          </p>
        </div>
      )}
    </div>
  )
}
```

### API 엔드포인트 구현

**요약 생성 API:**

```typescript
// app/api/notes/generate-summary/route.ts
export async function POST(request: NextRequest) {
  try {
    const { noteId, content } = await request.json()
    
    // 인증 확인
    const supabase = await createClient()
    const { data: { user }, error: authError } = await supabase.auth.getUser()
    if (authError || !user) {
      return NextResponse.json({ error: '인증이 필요합니다.' }, { status: 401 })
    }

    // 내용 길이 검증
    if (!content || content.length < 100) {
      return NextResponse.json({ 
        error: '요약하기에는 내용이 너무 짧습니다 (최소 100자)' 
      }, { status: 400 })
    }

    // 노트 소유권 확인
    const note = await db.query.notes.findFirst({
      where: and(eq(notes.id, noteId), eq(notes.userId, user.id))
    })
    if (!note) {
      return NextResponse.json({ error: '노트를 찾을 수 없습니다.' }, { status: 404 })
    }

    // 요약 생성 상태 업데이트
    await db.update(notes)
      .set({ summaryStatus: 'generating' })
      .where(eq(notes.id, noteId))

    // AI 요약 생성
    const prompt = `다음 노트 내용을 3-6개의 불릿 포인트로 요약해주세요:

${content}`

    const summary = await generateText(prompt, {
      maxTokens: 500,
      temperature: 0.3
    })

    // 요약 저장
    await db.update(notes)
      .set({
        summary: summary.trim(),
        summaryGeneratedAt: new Date(),
        summaryStatus: 'completed'
      })
      .where(eq(notes.id, noteId))

    return NextResponse.json({
      success: true,
      summary: summary.trim()
    })

  } catch (error) {
    console.error('요약 생성 에러:', error)
    
    // 실패 상태 업데이트
    if (noteId) {
      await db.update(notes)
        .set({ summaryStatus: 'failed' })
        .where(eq(notes.id, noteId))
    }
    
    return NextResponse.json(
      { error: '요약 생성에 실패했습니다.' },
      { status: 500 }
    )
  }
}
```

### 노트 폼 통합

**NoteForm에 요약 기능 추가:**

```typescript
// components/notes/note-form.tsx 업데이트
export function NoteForm({ noteId, initialData }: NoteFormProps) {
  // ... 기존 상태들
  const [autoSummary, setAutoSummary] = useState(true)

  return (
    <Card className="w-full max-w-2xl mx-auto">
      <CardContent>
        <form onSubmit={handleSubmit} className="space-y-4">
          {/* 기존 필드들 */}
          
          {/* 요약 생성 옵션 */}
          <div className="flex items-center space-x-2">
            <Switch
              id="auto-summary"
              checked={autoSummary}
              onCheckedChange={setAutoSummary}
            />
            <Label htmlFor="auto-summary">자동 요약 생성</Label>
          </div>

          {/* 요약 생성 컴포넌트 */}
          {autoSummary && content.length >= 100 && (
            <SummaryGenerator
              noteId={noteId}
              content={content}
              existingSummary={initialData?.summary}
              onSummaryGenerated={(summary) => {
                // 요약 상태 업데이트
              }}
            />
          )}

          {/* 기존 버튼들 */}
        </form>
      </CardContent>
    </Card>
  )
}
```

### 노트 목록에 요약 표시

**NoteCard에 요약 미리보기 추가:**

```typescript
// components/notes/note-card.tsx 업데이트
export function NoteCard({ note }: NoteCardProps) {
  return (
    <Card className="hover:shadow-md transition-shadow">
      <CardContent className="p-4">
        <div className="space-y-3">
          <div className="flex items-start justify-between">
            <h3 className="font-semibold text-lg line-clamp-1">
              {note.title}
            </h3>
            <time className="text-sm text-muted-foreground">
              {formatRelativeTime(note.updatedAt)}
            </time>
          </div>

          {/* 요약 표시 */}
          {note.summary && (
            <div className="bg-blue-50 p-3 rounded-md border-l-4 border-blue-200">
              <div className="flex items-center gap-2 mb-2">
                <Sparkles className="w-4 h-4 text-blue-600" />
                <span className="text-sm font-medium text-blue-800">AI 요약</span>
              </div>
              <p className="text-sm text-blue-700 line-clamp-3">
                {note.summary}
              </p>
            </div>
          )}

          {/* 기존 내용 미리보기 */}
          <p className="text-muted-foreground line-clamp-2">
            {generateNotePreview(note.content)}
          </p>

          {/* 기존 태그 및 버튼들 */}
        </div>
      </CardContent>
    </Card>
  )
}
```

### 성능 최적화

**요약 생성 최적화:**

1. **배치 처리:** 여러 노트의 요약을 한 번에 생성
2. **캐싱:** 동일한 내용의 요약 결과 재사용
3. **점진적 로딩:** 노트 목록에서 요약 지연 로딩
4. **토큰 최적화:** 불필요한 내용 제거 후 요약 생성

### 에러 처리 전략

**에러 타입별 처리:**

```typescript
export enum SummaryErrorType {
  CONTENT_TOO_SHORT = 'CONTENT_TOO_SHORT',
  CONTENT_TOO_LONG = 'CONTENT_TOO_LONG',
  AI_SERVICE_ERROR = 'AI_SERVICE_ERROR',
  TIMEOUT = 'TIMEOUT',
  PERMISSION_DENIED = 'PERMISSION_DENIED'
}

export function handleSummaryError(error: any): string {
  switch (error.type) {
    case SummaryErrorType.CONTENT_TOO_SHORT:
      return '노트 내용이 너무 짧습니다. 최소 100자 이상 입력해주세요.'
    case SummaryErrorType.CONTENT_TOO_LONG:
      return '노트 내용이 너무 깁니다. 내용을 줄여주세요.'
    case SummaryErrorType.TIMEOUT:
      return '요약 생성 시간이 초과되었습니다. 다시 시도해주세요.'
    default:
      return '요약 생성에 실패했습니다. 잠시 후 다시 시도해주세요.'
  }
}
```

### 테스트 시나리오

**단위 테스트:**

```typescript
describe('SummaryGenerator', () => {
  test('짧은 내용에 대해 에러 표시', () => {
    const shortContent = '짧은 노트'
    // 100자 미만 내용에 대한 에러 처리 테스트
  })

  test('요약 생성 성공 시나리오', async () => {
    const longContent = '충분히 긴 노트 내용...'
    // 정상적인 요약 생성 테스트
  })

  test('요약 재생성 기능', async () => {
    // 기존 요약이 있을 때 재생성 테스트
  })
})
```

**통합 테스트:**

```typescript
describe('Summary API Integration', () => {
  test('요약 생성 API 전체 플로우', async () => {
    // 노트 생성 → 요약 생성 → DB 저장 → 조회 테스트
  })

  test('동시 요청 처리', async () => {
    // 여러 요약 생성 요청 동시 처리 테스트
  })
})
```

## Change Log

| Date       | Version | Description | Author                    |
| ---------- | ------- | ----------- | ------------------------- |
| 2025-09-17 | 1.0     | 스토리 생성 | Dev Agent Claude 4 Sonnet |
| 2025-09-17 | 2.0     | 노트 자동 요약 기능 구현 완료 | Dev Agent Claude 4 Sonnet |

## Dev Agent Record

이 섹션은 개발 에이전트가 구현 중에 채워집니다.

### Agent Model Used

Claude 4 Sonnet (Anthropic)

### Debug Log References

- 데이터베이스 스키마 확장 완료 (2025-09-17)
- 요약 생성 API 엔드포인트 구현 완료
- 요약 UI 컴포넌트 및 노트 폼 통합 완료

### Completion Notes List

- ✅ notes 테이블에 summary, summaryGeneratedAt, summaryStatus 컬럼 추가
- ✅ 마이그레이션 파일 생성 및 데이터베이스 스키마 적용 완료
- ✅ 요약 생성 API 엔드포인트 (/api/notes/generate-summary) 구현
- ✅ SummaryGenerator 컴포넌트 구현 (로딩, 에러 처리, 편집 기능 포함)
- ✅ NoteForm에 요약 생성 옵션 및 2단계 플로우 구현
- ✅ NoteCard에 AI 요약 미리보기 기능 추가
- ✅ Switch 및 Alert UI 컴포넌트 추가
- ✅ 토큰 길이 검증 및 에러 처리 로직 구현
- ✅ 요약 후처리 및 불릿 포인트 포맷팅 완료

### File List

**새로 생성된 파일:**
- `app/api/notes/generate-summary/route.ts` - 요약 생성 API 엔드포인트
- `components/notes/summary-generator.tsx` - 요약 생성 UI 컴포넌트
- `components/ui/switch.tsx` - Switch UI 컴포넌트
- `components/ui/alert.tsx` - Alert UI 컴포넌트
- `drizzle/0001_new_maddog.sql` - 데이터베이스 마이그레이션 파일

**수정된 파일:**
- `lib/db/schema/notes.ts` - summary 관련 컬럼 추가
- `components/notes/note-form.tsx` - 요약 생성 기능 통합
- `components/notes/note-card.tsx` - AI 요약 미리보기 추가
- `package.json` - @radix-ui/react-switch 의존성 추가

## QA Results

QA 에이전트가 완료된 스토리 구현을 검토한 결과입니다.
