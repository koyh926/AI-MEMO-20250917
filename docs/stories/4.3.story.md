# Story 4.3: 노트 내용 기반 자동 태그 생성

## Status

Ready for Review

## Story

**As a** 사용자,
**I want** 작성한 노트의 내용을 바탕으로 AI가 자동으로 관련 태그를 생성해주는 기능,
**so that** 노트를 쉽게 분류하고 검색할 수 있어 정보 관리가 효율적이다.

## Acceptance Criteria

1. 노트 작성/수정 시 자동 태그 생성 옵션이 제공되어야 한다
2. 태그는 3-6개의 관련성 높은 키워드로 생성되어야 한다
3. 태그 생성 중 로딩 상태가 명확히 표시되어야 한다
4. 생성된 태그를 사용자가 수동으로 편집할 수 있어야 한다
5. 태그 재생성 기능이 제공되어야 한다
6. 노트 내용이 너무 짧은 경우 태그 생성을 제한해야 한다 (최소 50자)
7. AI 태그 생성 실패 시 적절한 에러 메시지를 표시해야 한다
8. 태그 생성 시간이 15초를 초과하면 타임아웃 처리되어야 한다
9. 노트 목록에서 태그를 미리볼 수 있어야 한다
10. 태그 데이터가 데이터베이스에 저장되어야 한다

## Tasks / Subtasks

- [x] 데이터베이스 스키마 확장 (AC: 10)
  - [x] notes 테이블에 tags 컬럼 추가 (JSON 배열 형태)
  - [x] 태그 생성 시간 및 상태 추적 필드 추가
  - [x] 마이그레이션 파일 생성 및 적용
- [x] 태그 생성 UI 컴포넌트 구현 (AC: 1, 3, 4, 5)
  - [x] 태그 생성 버튼 및 토글 스위치
  - [x] 태그 표시 및 편집 영역
  - [x] 로딩 스피너 및 진행 상태 표시
  - [x] 태그 재생성 버튼
- [x] 태그 생성 로직 구현 (AC: 2, 6, 7, 8)
  - [x] 노트 내용 길이 검증 (최소 50자)
  - [x] Gemini API 호출 로직 (기존 AI 인프라 활용)
  - [x] 태그 파싱 및 후처리
  - [x] 에러 처리 및 타임아웃 관리
- [x] 태그 데이터 관리 (AC: 9, 10)
  - [x] 태그 저장/조회 API 구현
  - [x] 노트 목록에 태그 표시 기능
  - [x] 태그 업데이트 로직
  - [x] 태그 삭제 및 재생성 처리

## Dev Notes

### 기술 스택 정보

[Source: docs/architecture.md#1-기술-스택]

- **프레임워크:** Next.js (App Router, Server Actions)
- **AI API:** Google Gemini API (@google/genai)
- **데이터베이스:** Supabase Postgres + Drizzle ORM
- **UI:** shadcn/ui + Tailwind CSS

### 이전 스토리 인사이트

[Source: docs/stories/4.2.story.md - Dev Agent Record]

- 4.2 스토리에서 요약 기능을 위한 AI 인프라가 이미 구축됨
- Gemini API 클라이언트 (`lib/ai/gemini-client.ts`) 정상 작동 확인
- 요약 생성 패턴을 태그 생성에 재사용 가능
- 기존 UI 컴포넌트 (Switch, Alert) 활용 가능
- 테스트용 AI API (`/api/ai/generate-tags`) 이미 구현되어 있음

### 데이터베이스 스키마 확장

**notes 테이블 확장:**

```sql
-- 태그 관련 컬럼 추가
ALTER TABLE notes ADD COLUMN tags TEXT[]; -- PostgreSQL 배열 형태
ALTER TABLE notes ADD COLUMN tags_generated_at TIMESTAMP;
ALTER TABLE notes ADD COLUMN tags_status VARCHAR(20) DEFAULT 'none';
-- tags_status: 'none', 'generating', 'completed', 'failed'
```

**Drizzle 스키마 업데이트:**

```typescript
// lib/db/schema/notes.ts
export const notes = pgTable('notes', {
  // ... 기존 필드들
  tags: text('tags').array(), // PostgreSQL 배열 타입
  tagsGeneratedAt: timestamp('tags_generated_at'),
  tagsStatus: varchar('tags_status', { length: 20 }).default('none'),
})
```

### API 사양

**태그 생성 API 엔드포인트:**

기존 `/api/ai/generate-tags` 를 참고하여 `/api/notes/generate-tags` 구현 필요

```typescript
// app/api/notes/generate-tags/route.ts
export async function POST(request: NextRequest) {
  // 인증 확인
  // 노트 소유권 확인
  // 내용 길이 검증 (최소 50자)
  // AI 태그 생성 (3-6개)
  // 태그 저장 및 반환
}
```

**프롬프트 설계:**

```typescript
const TAGS_PROMPT = `다음 노트 내용에 적합한 태그 3-6개를 생성해주세요.
태그는 한글로 작성하고, 관련성이 높은 키워드여야 합니다.

규칙:
- 각 태그는 2-8자 이내
- 중복 제거
- 관련성 순으로 정렬
- 태그만 응답 (콤마로 구분)

제목: {title}
내용: {content}

태그:`
```

### 컴포넌트 사양

**TagsGenerator 컴포넌트:**

```typescript
// components/notes/tags-generator.tsx
interface TagsGeneratorProps {
  noteId: string
  content: string
  existingTags?: string[]
  onTagsGenerated: (tags: string[]) => void
}

export function TagsGenerator({
  noteId,
  content,
  existingTags,
  onTagsGenerated
}: TagsGeneratorProps) {
  // 태그 생성 상태 관리
  // 태그 편집 기능
  // 재생성 기능
  // 에러 처리
}
```

### 파일 위치 및 구조

[Source: 기존 프로젝트 구조 분석]

**새로 생성할 파일:**
- `app/api/notes/generate-tags/route.ts` - 태그 생성 API 엔드포인트
- `components/notes/tags-generator.tsx` - 태그 생성 UI 컴포넌트
- `drizzle/000X_add_tags_columns.sql` - 데이터베이스 마이그레이션

**수정할 파일:**
- `lib/db/schema/notes.ts` - tags 관련 컬럼 추가
- `components/notes/note-form.tsx` - 태그 생성 기능 통합
- `components/notes/note-editor.tsx` - 기존 노트 편집 시 태그 기능
- `components/notes/note-card.tsx` - 노트 목록에 태그 표시

### 성능 최적화

**태그 생성 최적화:**

1. **캐싱:** 동일한 내용의 태그 결과 재사용
2. **배치 처리:** 여러 노트의 태그를 한 번에 생성
3. **점진적 로딩:** 노트 목록에서 태그 지연 로딩
4. **토큰 최적화:** 불필요한 내용 제거 후 태그 생성

### 에러 처리 전략

**에러 타입별 처리:**

```typescript
export enum TagsErrorType {
  CONTENT_TOO_SHORT = 'CONTENT_TOO_SHORT',
  CONTENT_TOO_LONG = 'CONTENT_TOO_LONG',
  AI_SERVICE_ERROR = 'AI_SERVICE_ERROR',
  TIMEOUT = 'TIMEOUT',
  PERMISSION_DENIED = 'PERMISSION_DENIED'
}

export function handleTagsError(error: any): string {
  switch (error.type) {
    case TagsErrorType.CONTENT_TOO_SHORT:
      return '노트 내용이 너무 짧습니다. 최소 50자 이상 입력해주세요.'
    case TagsErrorType.TIMEOUT:
      return '태그 생성 시간이 초과되었습니다. 다시 시도해주세요.'
    default:
      return '태그 생성에 실패했습니다. 잠시 후 다시 시도해주세요.'
  }
}
```

### Testing

**단위 테스트:**

```typescript
describe('TagsGenerator', () => {
  test('짧은 내용에 대해 에러 표시', () => {
    const shortContent = '짧은 노트'
    // 50자 미만 내용에 대한 에러 처리 테스트
  })

  test('태그 생성 성공 시나리오', async () => {
    const longContent = '충분히 긴 노트 내용...'
    // 정상적인 태그 생성 테스트
  })

  test('태그 재생성 기능', async () => {
    // 기존 태그가 있을 때 재생성 테스트
  })
})
```

**통합 테스트:**

```typescript
describe('Tags API Integration', () => {
  test('태그 생성 API 전체 플로우', async () => {
    // 노트 생성 → 태그 생성 → DB 저장 → 조회 테스트
  })

  test('동시 요청 처리', async () => {
    // 여러 태그 생성 요청 동시 처리 테스트
  })
})
```

## Change Log

| Date       | Version | Description | Author                    |
| ---------- | ------- | ----------- | ------------------------- |
| 2025-09-17 | 1.0     | 스토리 생성 | Scrum Master Bob Claude 4 Sonnet |

## Dev Agent Record

### Agent Model Used

Claude 4 Sonnet

### Debug Log References

- 데이터베이스 스키마 확장: 마이그레이션 0002_outstanding_lyja.sql 생성
- AI 태그 생성 API: 기존 `/api/ai/generate-tags` 기반으로 `/api/notes/generate-tags` 구현
- UI 컴포넌트: TagsGenerator 컴포넌트 구현 및 기존 폼들에 통합

### Completion Notes List

- 모든 Acceptance Criteria 충족 완료
- 데이터베이스 스키마 확장 및 마이그레이션 적용 완료
- 태그 생성, 편집, 재생성, 삭제 기능 구현 완료
- 노트 작성/편집 시 태그 기능 통합 완료
- 노트 목록에 태그 표시 기능 구현 완료
- 에러 처리 및 타임아웃 관리 구현 완료

### File List

**새로 생성된 파일:**
- `app/api/notes/generate-tags/route.ts` - 태그 생성 API 엔드포인트
- `components/notes/tags-generator.tsx` - 태그 생성 UI 컴포넌트
- `drizzle/0002_outstanding_lyja.sql` - 데이터베이스 마이그레이션

**수정된 파일:**
- `lib/db/schema/notes.ts` - tags 관련 컬럼 추가
- `components/notes/note-form.tsx` - 태그 생성 기능 통합
- `components/notes/note-editor.tsx` - 기존 노트 편집 시 태그 기능 추가
- `components/notes/note-card.tsx` - 노트 목록에 태그 표시
- `lib/notes/actions.ts` - 태그 업데이트 액션 추가

## QA Results

QA 에이전트가 완료된 스토리 구현을 검토한 결과입니다.
